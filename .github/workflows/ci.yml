name: CI/CD

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# Cancel redundant runs on same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ---------------------------------------------------------------------------
# LINT JOB – runs once on Linux
# ---------------------------------------------------------------------------
jobs:
  lint:
    name: Code Quality (Linux)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install lint dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: Run tests
        run: make test

      - name: Build Universal Binary
        run: |
          mkdir -p dist

          # Read version from Makefile
          MAJOR=$(grep '^MAJOR=' Makefile | cut -d= -f2)
          MINOR=$(grep '^MINOR=' Makefile | cut -d= -f2)
          PATCH=$(grep '^PATCH=' Makefile | cut -d= -f2)

          # Build arm64
          make clean
          CFLAGS="-arch arm64 -std=c99 -O2 -Wall -Werror -Wpedantic -pedantic-errors -DMAJOR=${MAJOR} -DMINOR=${MINOR} -DPATCH=${PATCH}" \
          LDFLAGS="-arch arm64 -pthread" make
          cp build/vframetest dist/vframetest-arm64

          # Build x86_64
          make clean
          CFLAGS="-arch x86_64 -std=c99 -O2 -Wall -Werror -Wpedantic -pedantic-errors -DMAJOR=${MAJOR} -DMINOR=${MINOR} -DPATCH=${PATCH}" \
          LDFLAGS="-arch x86_64 -pthread" make
          cp build/vframetest dist/vframetest-x86_64

          # Create universal binary
          lipo -create -output dist/vframetest-macos-universal dist/vframetest-arm64 dist/vframetest-x86_64
      - name: Code formatting check (clang-format)
        # This will FAIL the job if formatting is off
        run: |
          set -e
          echo "Running clang-format..."
          clang-format --dry-run --Werror src/*.c src/*.h tests/*.c tests/*.h 2>&1 | tee format-report.txt

      - name: Static analysis (cppcheck - non-blocking)
        continue-on-error: true
        run: |
          set -e
          echo "Running cppcheck..."
          cppcheck --enable=all --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            src/ tests/ 2>&1 | tee cppcheck-report.txt || true
          if grep -q "error:" cppcheck-report.txt; then
            echo "⚠️ Static analysis issues detected (non-blocking for now)"
          fi

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            format-report.txt
            cppcheck-report.txt
          if-no-files-found: warn
          retention-days: 7

  # ---------------------------------------------------------------------------
  # BUILD + TEST – matrix across macOS, Linux, Windows
  # ---------------------------------------------------------------------------
  build-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential cppcheck

      - name: Static Analysis
        run: |
          cppcheck --enable=warning,style,performance,portability --error-exitcode=1 --quiet src/
      # ---------- Per-OS dependencies ----------

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc clang make

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update >/dev/null || true
          brew install make || true

      - name: Install dependencies (Windows / MSYS2)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            make

      # ---------- Build + test for Linux/macOS ----------

      - name: Build & Test (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Build on $(uname -s) ==="
          make clean
          make -j4
          ./build/vframetest --version

      - name: Run tests
        shell: msys2 {0}
        run: make test

      - name: Collect benchmark data
        if: always()
        continue-on-error: true
          echo "=== Running tests ==="
          make test

      # ---------- Build + test for Windows (x86_64) ----------

      - name: Build & Test (Windows / MinGW)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: |
          set -euo pipefail

          echo "=== Build on Windows (MinGW64) ==="
          make clean
          make           # Makefile already knows how to build vframetest.exe
          ./build/vframetest.exe --version || {
            echo "❌ Version check failed"
            exit 1
          }

          echo "=== Running tests (if available) ==="
          if make -q test 2>/dev/null; then
            make test || echo "⚠️ Tests failed on Windows"
          else
            echo "No dedicated Windows test target; skipping."
          fi

      # ---------- Upload artifacts per OS ----------

      - name: Upload artifact (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: vframetest-linux-x86_64
          path: build/vframetest
          if-no-files-found: error
          retention-days: 30

      - name: Upload artifact (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: vframetest-macos
          path: build/vframetest
          if-no-files-found: error
          retention-days: 30

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: vframetest-windows-x86_64
          path: build/vframetest.exe
          if-no-files-found: error
          retention-days: 30

  # ---------------------------------------------------------------------------
  # RELEASE – runs only on tags v*
  # ---------------------------------------------------------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-test
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Release version: ${VERSION}"

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release

          echo "Artifacts tree:"
          ls -R artifacts || true

          # Linux
          if [ -f artifacts/vframetest-linux-x86_64/vframetest ]; then
            cp artifacts/vframetest-linux-x86_64/vframetest \
              "release/vframetest-${{ env.VERSION }}-linux-x86_64"
          fi

          # macOS
          if [ -f artifacts/vframetest-macos/vframetest ]; then
            cp artifacts/vframetest-macos/vframetest \
              "release/vframetest-${{ env.VERSION }}-macos"
          fi

          # Windows
          if [ -f artifacts/vframetest-windows-x86_64/vframetest.exe ]; then
            cp artifacts/vframetest-windows-x86_64/vframetest.exe \
              "release/vframetest-${{ env.VERSION }}-windows-x86_64.exe"
          fi

          cd release

          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum * > SHA256SUMS
          else
            shasum -a 256 * > SHA256SUMS
          fi

          echo "Final release contents:"
          ls -lh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
