name: CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Cancel redundant workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

# ============================================================================
# LINT JOB
# ============================================================================
jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: Code formatting check
        continue-on-error: true
        run: |
          clang-format --dry-run --Werror src/*.c src/*.h tests/*.c tests/*.h 2>&1 | tee format-report.txt
          if grep -q "error:" format-report.txt; then
            echo "❌ Code formatting errors found. Run: clang-format -i src/*.c src/*.h tests/*.c tests/*.h"
            exit 1
          fi

      - name: Static analysis (cppcheck)
        continue-on-error: true
        run: |
          cppcheck --enable=all --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            src/ tests/ 2>&1 | tee cppcheck-report.txt || true
          if grep -q "error:" cppcheck-report.txt; then
            echo "⚠️ Static analysis warnings found (non-blocking)"
          fi

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            format-report.txt
            cppcheck-report.txt
          if-no-files-found: warn
          retention-days: 7

  # ============================================================================
  # BUILD JOB - macOS + Linux (bash-only matrix)
  # ============================================================================
  build-unix:
    name: Build ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: lint
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos
            runner: macos-latest
            arch: universal
            cc: clang
            build_flags: "-arch arm64 -arch x86_64"
            artifact_suffix: macos-universal

          - os: macos
            runner: macos-latest
            arch: arm64
            cc: clang
            build_flags: "-arch arm64"
            artifact_suffix: macos-arm64

          - os: macos
            runner: macos-latest
            arch: x86_64
            cc: clang
            build_flags: "-arch x86_64"
            artifact_suffix: macos-x86_64

          # Linux builds
          - os: linux
            runner: ubuntu-latest
            arch: x86_64
            cc: gcc
            build_flags: ""
            artifact_suffix: linux-gcc-x86_64

          - os: linux
            runner: ubuntu-latest
            arch: x86_64
            cc: clang
            build_flags: ""
            artifact_suffix: linux-clang-x86_64

    env:
      CC: ${{ matrix.cc }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set build environment variables
        shell: bash
        run: |
          echo "BUILD_DIR=$(pwd)/build-${{ matrix.artifact_suffix }}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=vframetest-${{ matrix.artifact_suffix }}" >> $GITHUB_ENV
          echo "DIST_DIR=$(pwd)/dist-${{ matrix.artifact_suffix }}" >> $GITHUB_ENV

          MAJOR=$(grep '^MAJOR=' Makefile | cut -d= -f2)
          MINOR=$(grep '^MINOR=' Makefile | cut -d= -f2)
          PATCH=$(grep '^PATCH=' Makefile | cut -d= -f2)
          echo "VERSION=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_ENV

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cppcheck clang-format 2>/dev/null || echo "Tools may already be installed"

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc clang cppcheck clang-format

      - name: Build binary (*nix)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Build Configuration ==="
          echo "OS: ${{ matrix.os }}"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Compiler: ${{ matrix.cc }}"
          echo "Build Directory: ${{ env.BUILD_DIR }}"
          echo "Version: ${{ env.VERSION }}"
          echo ""

          BUILD_START=$(date +%s)

          mkdir -p "${{ env.BUILD_DIR }}"
          make clean BUILD_FOLDER="${{ env.BUILD_DIR }}" || true

          CFLAGS="${{ matrix.build_flags }} -DMAJOR=$(echo ${{ env.VERSION }} | cut -d. -f1) -DMINOR=$(echo ${{ env.VERSION }} | cut -d. -f2) -DPATCH=$(echo ${{ env.VERSION }} | cut -d. -f3)"

          make BUILD_FOLDER="${{ env.BUILD_DIR }}" CFLAGS="$CFLAGS"

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV

          if [ "${{ matrix.os }}" = "macos" ]; then
            BINARY="${{ env.BUILD_DIR }}/vframetest"
          else
            BINARY="${{ env.BUILD_DIR }}/vframetest"
          fi

          if [ ! -f "$BINARY" ]; then
            echo "❌ Build failed: Binary not found at $BINARY"
            exit 1
          fi

          echo "✅ Build successful"
          ls -lh "$BINARY"

      - name: Verify binary functionality (*nix)
        shell: bash
        run: |
          set -euo pipefail
          BINARY="${{ env.BUILD_DIR }}/vframetest"

          echo "=== Smoke Test: Version Check ==="
          "$BINARY" --version || {
            echo "❌ Binary version check failed"
            exit 1
          }
          echo "✅ Smoke test passed"

      - name: Create universal binary (macOS arm64+x86_64 only)
        if: matrix.os == 'macos' && matrix.arch == 'universal'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ env.DIST_DIR }}"

          VMAJOR=$(echo ${{ env.VERSION }} | cut -d. -f1)
          VMINOR=$(echo ${{ env.VERSION }} | cut -d. -f2)
          VPATCH=$(echo ${{ env.VERSION }} | cut -d. -f3)

          # Build arm64
          make clean BUILD_FOLDER="${{ env.BUILD_DIR }}/arm64"
          make BUILD_FOLDER="${{ env.BUILD_DIR }}/arm64" CFLAGS="-arch arm64 -DMAJOR=${VMAJOR} -DMINOR=${VMINOR} -DPATCH=${VPATCH}"
          cp "${{ env.BUILD_DIR }}/arm64/vframetest" "${{ env.DIST_DIR }}/vframetest-arm64"

          # Build x86_64
          make clean BUILD_FOLDER="${{ env.BUILD_DIR }}/x86_64"
          make BUILD_FOLDER="${{ env.BUILD_DIR }}/x86_64" CFLAGS="-arch x86_64 -DMAJOR=${VMAJOR} -DMINOR=${VMINOR} -DPATCH=${VPATCH}"
          cp "${{ env.BUILD_DIR }}/x86_64/vframetest" "${{ env.DIST_DIR }}/vframetest-x86_64"

          # Create universal binary
          lipo -create -output "${{ env.DIST_DIR }}/vframetest-macos-universal" \
            "${{ env.DIST_DIR }}/vframetest-arm64" \
            "${{ env.DIST_DIR }}/vframetest-x86_64"

          file "${{ env.DIST_DIR }}/vframetest-macos-universal"
          echo "✅ Universal binary created"

      - name: Prepare artifacts for upload
        if: always()
        shell: bash
        run: |
          mkdir -p "${{ env.DIST_DIR }}"

          BINARY="${{ env.BUILD_DIR }}/vframetest"
          if [ -f "$BINARY" ]; then
            cp "$BINARY" "${{ env.DIST_DIR }}/"
          fi

          echo "Artifacts prepared in ${{ env.DIST_DIR }}"
          ls -lh "${{ env.DIST_DIR }}" || echo "No artifacts found"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.DIST_DIR }}/
          if-no-files-found: warn
          retention-days: 30

      - name: Generate build report
        if: always()
        shell: bash
        run: |
          cat > build-report-${{ matrix.artifact_suffix }}.txt << EOF
          Build Report
          ============
          OS: ${{ matrix.os }}
          Architecture: ${{ matrix.arch }}
          Compiler: ${{ matrix.cc }}
          Version: ${{ env.VERSION }}
          Duration: ${{ env.BUILD_DURATION }}s
          Status: ${{ job.status }}
          Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Commit: ${{ github.sha }}
          EOF
          cat build-report-${{ matrix.artifact_suffix }}.txt

      - name: Upload build reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # UNIQUE name per matrix entry (fixes 409 conflicts)
          name: build-reports-${{ matrix.artifact_suffix }}
          path: build-report-${{ matrix.artifact_suffix }}.txt
          if-no-files-found: warn
          retention-days: 7

  # ============================================================================
  # BUILD JOB - Windows (separate job, MSYS2 shell)
  # ============================================================================
  build-windows:
    name: Build windows (${{ matrix.arch }})
    runs-on: windows-latest
    needs: lint
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, i686]
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-i686-toolchain
            make
            cppcheck

      - name: Set build environment
        run: |
          echo "BUILD_DIR=$(pwd)/build-windows-${{ matrix.arch }}" >> $GITHUB_ENV
          echo "DIST_DIR=$(pwd)/dist-windows-${{ matrix.arch }}" >> $GITHUB_ENV

          MAJOR=$(grep '^MAJOR=' Makefile | cut -d= -f2)
          MINOR=$(grep '^MINOR=' Makefile | cut -d= -f2)
          PATCH=$(grep '^PATCH=' Makefile | cut -d= -f2)
          echo "VERSION=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_ENV

      - name: Build binary (Windows)
        run: |
          set -euo pipefail

          echo "=== Build Configuration (Windows) ==="
          echo "Arch: ${{ matrix.arch }}"
          echo "Build Directory: ${{ env.BUILD_DIR }}"
          echo "Version: ${{ env.VERSION }}"

          BUILD_START=$(date +%s)

          mkdir -p "${{ env.BUILD_DIR }}"
          make clean BUILD_FOLDER="${{ env.BUILD_DIR }}" || true

          VMAJOR=$(echo ${{ env.VERSION }} | cut -d. -f1)
          VMINOR=$(echo ${{ env.VERSION }} | cut -d. -f2)
          VPATCH=$(echo ${{ env.VERSION }} | cut -d. -f3)
          CFLAGS="-DMAJOR=${VMAJOR} -DMINOR=${VMINOR} -DPATCH=${VPATCH}"

          if [ "${{ matrix.arch }}" = "i686" ]; then
            CROSS=i686-w64-mingw32- make BUILD_FOLDER="${{ env.BUILD_DIR }}" CFLAGS="$CFLAGS"
          else
            make BUILD_FOLDER="${{ env.BUILD_DIR }}" CFLAGS="$CFLAGS"
          fi

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV

          BINARY="${{ env.BUILD_DIR }}/vframetest.exe"
          if [ ! -f "$BINARY" ]; then
            echo "❌ Build failed: Binary not found at $BINARY"
            exit 1
          fi

          echo "✅ Build successful"
          ls -lh "$BINARY"

      - name: Smoke test (Windows)
        run: |
          set -euo pipefail
          BINARY="${{ env.BUILD_DIR }}/vframetest.exe"

          echo "=== Smoke Test: Version Check (Windows) ==="
          "$BINARY" --version || {
            echo "❌ Binary version check failed"
            exit 1
          }
          echo "✅ Smoke test passed"

      - name: Prepare artifacts for upload
        if: always()
        run: |
          mkdir -p "${{ env.DIST_DIR }}"
          BINARY="${{ env.BUILD_DIR }}/vframetest.exe"
          if [ -f "$BINARY" ]; then
            cp "$BINARY" "${{ env.DIST_DIR }}/vframetest-windows-${{ matrix.arch }}.exe"
          fi
          ls -lh "${{ env.DIST_DIR }}" || echo "No artifacts found"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vframetest-windows-${{ matrix.arch }}
          path: ${{ env.DIST_DIR }}/
          if-no-files-found: warn
          retention-days: 30

      - name: Upload build report
        if: always()
        run: |
          cat > build-report-windows-${{ matrix.arch }}.txt << EOF
          Build Report
          ============
          OS: windows
          Architecture: ${{ matrix.arch }}
          Version: ${{ env.VERSION }}
          Duration: ${{ env.BUILD_DURATION }}s
          Status: ${{ job.status }}
          Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          Commit: ${{ github.sha }}
          EOF

      - name: Upload build report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-windows-${{ matrix.arch }}
          path: build-report-windows-${{ matrix.arch }}.txt
          if-no-files-found: warn
          retention-days: 7

  # ============================================================================
  # TEST JOBS
  # ============================================================================
  test-unix:
    name: Test ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: [build-unix]
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            arch: x86_64
          - os: macos
            runner: macos-latest
            arch: x86_64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set test environment variables
        shell: bash
        run: |
          echo "BUILD_DIR=$(pwd)/build-test" >> $GITHUB_ENV
          MAJOR=$(grep '^MAJOR=' Makefile | cut -d= -f2)
          MINOR=$(grep '^MINOR=' Makefile | cut -d= -f2)
          PATCH=$(grep '^PATCH=' Makefile | cut -d= -f2)
          echo "VERSION=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_ENV

      - name: Install test dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc clang valgrind

      - name: Install test dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install valgrind 2>/dev/null || echo "Valgrind may not be available on macOS"

      - name: Build and run unit tests (*nix)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Running Unit Tests ==="
          make test BUILD_FOLDER="${{ env.BUILD_DIR }}"
          echo "✅ Unit tests passed"

      - name: Run memory leak detection (Linux only)
        if: runner.os == 'Linux'
        continue-on-error: true
        run: |
          echo "=== Memory Leak Detection ==="
          valgrind --leak-check=full --show-leak-kinds=all \
            --track-origins=yes --verbose \
            "${{ env.BUILD_DIR }}/test-runner" 2>&1 | head -100 || echo "⚠️ Valgrind check completed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            ${{ env.BUILD_DIR }}/test-*.txt
            ${{ env.BUILD_DIR }}/coverage-*.txt
          if-no-files-found: warn
          retention-days: 7

  test-windows:
    name: Test windows (x86_64)
    runs-on: windows-latest
    needs: [build-windows]
    permissions:
      contents: read
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            make

      - name: Set test env
        run: |
          echo "BUILD_DIR=$(pwd)/build-test-windows" >> $GITHUB_ENV

      - name: Build and run unit tests (Windows)
        run: |
          set -euo pipefail
          echo "=== Running Unit Tests (Windows) ==="
          make test BUILD_FOLDER="${{ env.BUILD_DIR }}"
          echo "✅ Unit tests passed"

  # ============================================================================
  # PACKAGE JOB
  # ============================================================================
  package:
    name: Package Release
    runs-on: ubuntu-latest
    needs: [build-unix, build-windows, test-unix, test-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set package environment
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "RELEASE_DIR=$(pwd)/release-${VERSION}" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ env.RELEASE_DIR }}"
          echo "=== Organizing Release Artifacts ==="
          find artifacts -name "vframetest*" -type f | while read artifact; do
            filename=$(basename "$artifact")
            target_name="vframetest-${{ env.VERSION }}-${filename#vframetest-}"
            cp "$artifact" "${{ env.RELEASE_DIR }}/${target_name}"
            echo "Packaged: ${target_name}"
          done
          echo "=== Release Artifacts ==="
          ls -lh "${{ env.RELEASE_DIR }}/" || echo "No artifacts found"

      - name: Generate checksums
        shell: bash
        run: |
          cd "${{ env.RELEASE_DIR }}"
          if command -v sha256sum > /dev/null; then
            sha256sum * > SHA256SUMS
          elif command -v shasum > /dev/null; then
            shasum -a 256 * > SHA256SUMS
          fi
          cat SHA256SUMS

      - name: Generate release notes
        shell: bash
        run: |
          cat > "${{ env.RELEASE_DIR }}/RELEASE_NOTES.md" << EOF
          # Release ${{ env.VERSION }}

          ## Build Information
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          - Build Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          ## Artifacts
          - vframetest-${{ env.VERSION }}-macos-universal
          - vframetest-${{ env.VERSION }}-macos-arm64
          - vframetest-${{ env.VERSION }}-macos-x86_64
          - vframetest-${{ env.VERSION }}-linux-gcc-x86_64
          - vframetest-${{ env.VERSION }}-linux-clang-x86_64
          - vframetest-${{ env.VERSION }}-windows-x86_64.exe
          - vframetest-${{ env.VERSION }}-windows-i686.exe

          ## Verification
          - Verify checksums: sha256sum -c SHA256SUMS
          EOF
          cat "${{ env.RELEASE_DIR }}/RELEASE_NOTES.md"

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ env.VERSION }}
          path: ${{ env.RELEASE_DIR }}/
          retention-days: 90

  # ============================================================================
  # DEPLOY JOB
  # ============================================================================
  deploy:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set deployment environment
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-${{ env.VERSION }}
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # STATUS CHECK
  # ============================================================================
  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, build-unix, build-windows, test-unix, test-windows]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Check job statuses
        shell: bash
        run: |
          echo "=== CI/CD Pipeline Status ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build-unix: ${{ needs.build-unix.result }}"
          echo "Build-windows: ${{ needs.build-windows.result }}"
          echo "Test-unix: ${{ needs.test-unix.result }}"
          echo "Test-windows: ${{ needs.test-windows.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ]; then
            echo "❌ Lint failed"
            exit 1
          fi
          if [ "${{ needs.build-unix.result }}" != "success" ]; then
            echo "❌ Unix build failed"
            exit 1
          fi
          if [ "${{ needs.build-windows.result }}" != "success" ]; then
            echo "❌ Windows build failed"
            exit 1
          fi
          if [ "${{ needs.test-unix.result }}" != "success" ]; then
            echo "❌ Unix tests failed"
            exit 1
          fi
          if [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "❌ Windows tests failed"
            exit 1
          fi

          echo "✅ All checks passed"
